<!DOCTYPE html>
<html lang="en">

<head>

	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Yo OT WebRTC</title>

	<meta name="description" content="">
	<meta name="author" content="">

	<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">

	<!-- removeIf(build) -->
	<!-- build:js css/assets.css -->

	<!-- bower:css -->
	<link rel="stylesheet" href="bower_components/normalize-css/normalize.css" />
	<link rel="stylesheet" href="bower_components/codemirror/lib/codemirror.css" />
	<!-- endbower -->

	<!-- endbuild -->
	<!-- endRemoveIf(build) -->

	<!-- build:js css/style.css -->
	<!-- inject:css -->
	<link rel="stylesheet" href=".tmp/style.css">
	<!-- endinject -->
	<!-- endbuild -->

</head>

<body>

	<div>
		<textarea id="editor" cols="120" rows="30"></textarea>
	</div>

	<br/><br/>

	<div>
		<button id="share">Start share</button>

		<pre id="sessions" />

	</div>


	<!-- removeIf(build) -->
	<!-- build:js scripts/assets.js -->

	<!-- bower:js -->
	<script src="bower_components/modernizr/modernizr.js"></script>
	<script src="bower_components/jquery/dist/jquery.js"></script>
	<script src="bower_components/codemirror/lib/codemirror.js"></script>
	<script src="bower_components/ot/dist/ot.js"></script>
	<script src="bower_components/webrtc-adapter/release/adapter.js"></script>
	<!-- endbower -->

	<!-- endbuild -->
	<!-- endRemoveIf(build) -->

	<!-- build:js scripts/scripts.js -->
	<!-- inject:js -->
	<script src="scripts/init.js"></script>
	<script src="scripts/sessions.js"></script>
	<!-- endinject -->
	<!-- endbuild -->


</body>

</html>

<script>

	var user = "Aslak"

	var pc = new RTCPeerConnection({ "iceServers": [{ "url": "stun:stun.l.google.com:19302" }] });
	pc.ondatachannel = function (ev) {
		console.log('Data channel is created!');
		ev.channel.onopen = function () {
			console.log('Data channel is open and ready to be used.');
		};
	};
	pc.onicecandidate = function (e) {
		console.log("onicecandidate: " + e)
	}
	pc.oniceconnectionstatechange = function (e) {
		console.log("oniceconnectionstatechange: " + e)
	}
	pc.onnegotiationneeded = function (e) {
		console.log("onnegotiationneeded: " + e)
	}
	pc.onsignalingstatechange = function (e) {
		console.log("onsignalingstatechange: " + e)
	}

	function error(err) {
		console.log(err)
		pc.close()
	}
	var sessionOwner = false

	var session = Session("http://192.168.0.174:8080", "A")
	$("#share").click(function () {
		pc.createOffer(function (offer) {
			pc.setLocalDescription(offer, function () {
				session.whoami = function () {
					return {
						"name": user,
						"peerid": offer
					}
				}
				sessionOwner = true
				session.start()
				console.log("Owner: Created session")
			}, error);
		}, error);
	})

	setInterval(function () {
		session.sessions().success(function (resp) {
			$("#sessions").html("")
			for (var i = 0; i < resp.length; i++) {
				if (sessionOwner) {
					if (resp[i].participants != null && resp[i].participants.length > 0) {
						console.log("Owner: Answer session: " + resp[i].participants[0].peerid.type)
						pc.setRemoteDescription(new RTCSessionDescription(resp[i].participants[0].peerid), function () { }, error);
						console.log("Owner: Create data channel")
						var channel = pc.createDataChannel(null, {})
						channel.onmessage = function (msg) {
							console.log(msg)
							channel.send(msg + 1)
						}
						channel.onopen = function () {
							console.log('Data channel is open and ready to be used.');
						}
						channel.onclose = function () {
							console.log('Data channel is closed.');
						}
						channel.onerror = function (err) {
							console.log('Data channel is in error ' + err);
						}

						sessionOwner = false

					}
				}
				var s = $("<div>")
				s.append($("<button>join</button>").click(
					function (index) {
						return function () {
							pc.setRemoteDescription(new RTCSessionDescription(resp[index].owner.peerid), function () {
								pc.createAnswer(function (answer) {
									pc.setLocalDescription(answer, function () {
										session.whoami = function () {
											return {
												"name": user,
												"peerid": answer
											}
										}
										session.join(index)
										console.log("Participant: Join session")
									}, error);
								}, error);
							}, error);
						}
					} (i)))
				s.append($("<div>" + JSON.stringify(resp[i], null, 4) + "</div>"))
				$("#sessions").append(s).append($("<br/>"))
			}
		})
	}, 2000)


</script>