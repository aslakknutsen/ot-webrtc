<!DOCTYPE html>
<html lang="en">

<head>

	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Yo OT WebRTC</title>

	<meta name="description" content="">
	<meta name="author" content="">

	<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">

	<!-- removeIf(build) -->
	<!-- build:js css/assets.css -->

	<!-- bower:css -->
	<link rel="stylesheet" href="bower_components/normalize-css/normalize.css" />
	<link rel="stylesheet" href="bower_components/codemirror/lib/codemirror.css" />
	<!-- endbower -->

	<!-- endbuild -->
	<!-- endRemoveIf(build) -->

	<!-- build:js css/style.css -->
	<!-- inject:css -->
	<link rel="stylesheet" href=".tmp/style.css">
	<!-- endinject -->
	<!-- endbuild -->

</head>

<body>

	<div>
		<textarea id="editor" cols="120" rows="30"></textarea>
	</div>

	<br/><br/>

	<div>
		<button id="share">Start share</button>

		<pre id="sessions" />

	</div>


	<!-- removeIf(build) -->
	<!-- build:js scripts/assets.js -->

	<!-- bower:js -->
	<script src="bower_components/modernizr/modernizr.js"></script>
	<script src="bower_components/jquery/dist/jquery.js"></script>
	<script src="bower_components/codemirror/lib/codemirror.js"></script>
	<script src="bower_components/ot/dist/ot.js"></script>
	<script src="bower_components/webrtc-adapter/release/adapter.js"></script>
	<script src="bower_components/peerjs/peer.js"></script>
	<!-- endbower -->

	<!-- endbuild -->
	<!-- endRemoveIf(build) -->

	<!-- build:js scripts/scripts.js -->
	<!-- inject:js -->
	<script src="scripts/init.js"></script>
	<script src="scripts/sessions.js"></script>
	<!-- endinject -->
	<!-- endbuild -->


</body>

</html>

<script>

	var user = getParameterByName("user")

	var peer = new Peer(user, { host: '192.168.0.174', port: 9000, secure: false, debug: 3 });
	peer.on('open', function (id) {
		console.log('My peer ID is: ' + id);

	});
	peer.on('connection', function (conn) {

		conn.on('data', function (data) {
			console.log('Received', data);
			conn.send("weee")
		});
	});


	var session = Session('http://192.168.0.174:8080', 'A')
	$('#share').click(function () {
		session.whoami = function () {
			return {
				'name': user,
			}
		}
		session.start()
	})

	setInterval(function () {
		session.sessions().success(function (resp) {
			$('#sessions').html('')
			for (var i = 0; i < resp.length; i++) {
				var s = $('<div>')
				s.append($('<button>join</button>').click(
					function (index) {
						return function () {
							session.whoami = function () {
								return {
									name: user,
								}
							}
							session.join(index)
							var conn = peer.connect(resp[index].owner.name);
							conn.on('open', function () {
								// Receive messages
								conn.on('data', function (data) {
									console.log('Received', data);
								});

								// Send messages
								conn.send('Hello!');
							});
						}
					} (i)));
				s.append($("<div>" + JSON.stringify(resp[i], null, 4) + "</div>"))
				$("#sessions").append(s).append($("<br/>"))
			}
		})
	}, 2000)

	function getParameterByName(name, url) {
		if (!url) {
			url = window.location.href;
		}
		name = name.replace(/[\[\]]/g, "\\$&");
		var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
			results = regex.exec(url);
		if (!results) return null;
		if (!results[2]) return '';
		return decodeURIComponent(results[2].replace(/\+/g, " "));
	}
</script>